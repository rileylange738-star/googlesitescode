<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>3D Print Instant Quote</title>
<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/loaders/STLLoader.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
#drop-area { border: 2px dashed #ccc; border-radius: 10px; padding: 40px; text-align: center; color: #555; }
#quote { margin-top: 20px; font-size: 18px; font-weight: bold; }
select { font-size: 16px; margin-top: 10px; }
</style>
</head>
<body>

<h2>3D Print Instant Quote</h2>
<div id="drop-area">
  Drag & drop your STL file here or click to select.
  <input type="file" id="fileInput" style="display:none;">
</div>

<div>
  Material: 
  <select id="materialSelect">
    <option value="PLA">PLA ($0.12/g)</option>
    <option value="PETG">PETG ($0.12/g)</option>
    <option value="TPU">TPU ($0.20/g)</option>
  </select>
</div>

<div id="quote">Quote will appear here</div>

<script>
const dropArea = document.getElementById('drop-area');
const fileInput = document.getElementById('fileInput');
const quoteDiv = document.getElementById('quote');
const materialSelect = document.getElementById('materialSelect');

// Prices per gram
const prices = { PLA: 0.12, PETG: 0.12, TPU: 0.20 };

// Drag & drop handling
dropArea.addEventListener('click', () => fileInput.click());
dropArea.addEventListener('dragover', e => { e.preventDefault(); dropArea.style.backgroundColor = '#f0f0f0'; });
dropArea.addEventListener('dragleave', e => { e.preventDefault(); dropArea.style.backgroundColor = ''; });
dropArea.addEventListener('drop', e => {
  e.preventDefault();
  dropArea.style.backgroundColor = '';
  const files = e.dataTransfer.files;
  if(files.length) handleFile(files[0]);
});
fileInput.addEventListener('change', e => { if(e.target.files.length) handleFile(e.target.files[0]); });

// Handle STL file
function handleFile(file) {
  quoteDiv.innerText = "Calculating...";
  const reader = new FileReader();
  reader.onload = function(e) {
    const arrayBuffer = e.target.result;
    const loader = new THREE.STLLoader();
    const geometry = loader.parse(arrayBuffer);
    calculateWeightAndPrice(geometry);
  };
  reader.readAsArrayBuffer(file);
}

// Calculate weight and price
function calculateWeightAndPrice(geometry) {
  // Rough volume calculation
  const position = geometry.attributes.position.array;
  let volume = 0;
  for(let i=0; i<position.length; i+=9){
    const ax=position[i], ay=position[i+1], az=position[i+2];
    const bx=position[i+3], by=position[i+4], bz=position[i+5];
    const cx=position[i+6], cy=position[i+7], cz=position[i+8];
    // Tetrahedron volume formula
    volume += Math.abs(
      (ax*(by*cz - bz*cy) - ay*(bx*cz - bz*cx) + az*(bx*cy - by*cx))/6
    );
  }
  const volume_cm3 = volume / 1000; // convert mm³ to cm³
  // Approximate density g/cm³
  const densities = { PLA: 1.24, PETG: 1.27, TPU: 1.20 };
  const material = materialSelect.value;
  const weight = volume_cm3 * densities[material];
  const price = weight * prices[material];
  quoteDiv.innerText = `${weight.toFixed(1)} g — $${price.toFixed(2)}`;
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>3D Print Instant Quote</title>
<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/loaders/STLLoader.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
#drop-area { border: 2px dashed #ccc; border-radius: 10px; padding: 40px; text-align: center; color: #555; cursor: pointer; }
#drop-area.dragover { background-color: #f0f0f0; }
#quote { margin-top: 20px; font-size: 18px; font-weight: bold; display: flex; align-items: center; }
.spinner { border: 4px solid #f3f3f3; border-top: 4px solid #555; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin-right: 10px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
select { font-size: 16px; margin-top: 10px; }
</style>
</head>
<body>

<h2>3D Print Instant Quote</h2>
<div id="drop-area">
  Drag & drop your STL file here or click to select.
  <input type="file" id="fileInput" style="display:none;">
</div>

<div>
  Material: 
  <select id="materialSelect">
    <option value="PLA">PLA ($0.12/g)</option>
    <option value="PETG">PETG ($0.12/g)</option>
    <option value="TPU">TPU ($0.20/g)</option>
  </select>
</div>

<div id="quote">Quote will appear here</div>

<script>
const dropArea = document.getElementById('drop-area');
const fileInput = document.getElementById('fileInput');
const quoteDiv = document.getElementById('quote');
const materialSelect = document.getElementById('materialSelect');
const prices = { PLA: 0.12, PETG: 0.12, TPU: 0.20 };

// Drag & drop
dropArea.addEventListener('click', () => fileInput.click());
dropArea.addEventListener('dragover', e => { e.preventDefault(); dropArea.classList.add('dragover'); });
dropArea.addEventListener('dragleave', e => { e.preventDefault(); dropArea.classList.remove('dragover'); });
dropArea.addEventListener('drop', e => {
  e.preventDefault();
  dropArea.classList.remove('dragover');
  if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', e => { if(e.target.files.length) handleFile(e.target.files[0]); });

function handleFile(file) {
  quoteDiv.innerHTML = '<div class="spinner"></div>Calculating...';
  setTimeout(() => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const loader = new THREE.STLLoader();
      const geometry = loader.parse(e.target.result);
      geometry.computeVertexNormals();
      calculateWeightAndPrice(geometry);
    };
    reader.readAsArrayBuffer(file);
  }, 50);
}

// Triangle volume calculation
function triangleVolume(a,b,c){
  return Math.abs(a.dot(b.cross(c))) / 6;
}

function calculateWeightAndPrice(geometry){
  let position = geometry.attributes.position.array;
  let volume_mm3 = 0;
  for(let i=0; i<position.length; i+=9){
    const a = new THREE.Vector3(position[i],position[i+1],position[i+2]);
    const b = new THREE.Vector3(position[i+3],position[i+4],position[i+5]);
    const c = new THREE.Vector3(position[i+6],position[i+7],position[i+8]);
    volume_mm3 += triangleVolume(a,b,c);
  }
  const volume_cm3 = volume_mm3 / 1000; // mm³ -> cm³
  const densities = { PLA: 1.24, PETG: 1.27, TPU: 1.20 };
  const material = materialSelect.value;
  const weight = volume_cm3 * densities[material];
  const price = weight * prices[material];
  quoteDiv.innerText = `${weight.toFixed(1)} g — $${price.toFixed(2)}`;
}
</script>

</body>
</html>
